<body onclick="initAudio()">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
// --- 1. CẤU HÌNH KẾT NỐI ---
const SERVER_URL = "https://tiu-xai-server.onrender.com"; 
const SUPABASE_URL = "https://qimyjctcipdgkfhudunv.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."; 

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let socket;
let balance = 0, selectedAmt = 100000, timer = 30, phase = 'BET';
let mySide = null, pendingMoney = 0, confirmedMoney = 0;
let resDice = [1, 1, 1];

// Thêm hàm initAudio để tránh lỗi khi click vào body
function initAudio() {
    console.log("Audio initialized");
}

async function startLoading() {
    const { data: { session }, error } = await supabaseClient.auth.getSession();
    
    if (!session || error) {
        alert("Phiên đăng nhập hết hạn hoặc chưa đăng nhập!");
        return;
    }

    await fetchUserBalance(session.user.id);

    socket = io(SERVER_URL, {
        auth: { token: session.access_token },
        transports: ["websocket"]
    });

    document.getElementById('login-overlay').style.display = 'none';
    document.getElementById('loading-screen').style.display = 'flex';
    
    setupSocketListeners();
    
    setTimeout(() => {
        const loadingScreen = document.getElementById('loading-screen');
        if(loadingScreen) loadingScreen.style.display = 'none';
    }, 2000);
}

async function fetchUserBalance(userId) {
    const { data, error } = await supabaseClient
        .from('players')
        .select('balance')
        .eq('id', userId)
        .single();

    if (data) {
        balance = data.balance;
        updateUI();
    }
}

function setupSocketListeners() {
    socket.on('init', (data) => {
        phase = data.phase;
        timer = data.timer;
        const sessionEl = document.getElementById('session-id');
        if(sessionEl) sessionEl.innerText = data.session;
        updateUI();
    });

    socket.on('tick', (data) => {
        timer = data.timer;
        phase = data.phase;
        updateUI();
    });

    socket.on('open-result', (data) => {
        resDice = data.dices;
        phase = 'NAN'; 
        const nanText = document.getElementById('nan-text');
        if(nanText) nanText.style.display = 'block';
        
        // Gọi hàm hiển thị xúc xắc nếu bạn đã định nghĩa
        if(typeof showDiceUI === "function") showDiceUI(data.dices);
    });

    socket.on('new-session', (data) => {
        // Reset các biến cược cho ván mới
        mySide = null;
        pendingMoney = 0;
        confirmedMoney = 0;
        
        const sessionEl = document.getElementById('session-id');
        if(sessionEl) sessionEl.innerText = data.session;
        
        // Gọi hàm xóa chip trên bàn nếu bạn đã định nghĩa
        if(typeof resetGameUI === "function") resetGameUI();
    });

    socket.on('bet-ok', (data) => {
        confirmedMoney += pendingMoney;
        pendingMoney = 0;
        if (data && data.newBalance !== undefined) balance = data.newBalance;
        updateUI();
        
        document.querySelectorAll('.pending-chip').forEach(chip => {
            chip.classList.replace('pending-chip', 'chip-confirmed');
        });
    });

    socket.on('update-balance', (newBalance) => {
        balance = newBalance;
        updateUI();
    });

    socket.on('error', (msg) => {
        alert(msg);
    });
}

function confirmBet() {
    if (pendingMoney <= 0) return;
    if (phase !== 'BET' || timer <= 2) {
        alert("Không thể đặt cược lúc này!");
        return;
    }
    
    socket.emit('bet', { side: mySide, amount: pendingMoney });
}

function updateUI() {
    const balEl = document.getElementById('balance');
    const timerEl = document.getElementById('bowl-timer');
    
    if (balEl) balEl.innerText = Math.floor(balance).toLocaleString();
    if (timerEl) {
        timerEl.innerText = timer;
        // Hiệu ứng đổi màu khi sắp hết giờ
        timerEl.style.color = (timer <= 5 && phase === 'BET') ? '#ff4d4d' : '#fff';
    }
}
</script>
</body>
