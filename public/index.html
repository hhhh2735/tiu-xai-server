<body onclick="initAudio()">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
// --- CẤU HÌNH KẾT NỐI ---
const SERVER_URL = "https://tiu-xai-server.onrender.com"; 
const SUPABASE_URL = "https://qimyjctcipdgkfhudunv.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."; // Copy Anon Key từ Supabase của bạn

const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let socket;

let balance = 0, selectedAmt = 100000, timer = 30, phase = 'BET';
let mySide = null, pendingMoney = 0, confirmedMoney = 0;
let resDice = [1,1,1], roadData = [];

// --- HÀM LOGIN THẬT ---
async function startLoading() {
    const email = document.getElementById('user-input-name').value.trim(); // Ở đây bạn nên dùng Email/Pass nếu làm thật
    
    // Giả sử bạn dùng Supabase Auth để lấy Token
    // Trong ví dụ này, để khớp với Backend bạn gửi, ta cần một Token hợp lệ
    const { data: { session }, error } = await supabase.auth.getSession();
    
    if (!session) {
        alert("Vui lòng đăng nhập qua Supabase trước!");
        return;
    }

    const token = session.access_token;

    // KẾT NỐI SOCKET VỚI TOKEN (Khớp với authSocket middleware)
    socket = io(SERVER_URL, {
        auth: { token: token },
        transports: ["websocket"]
    });

    // Chạy hiệu ứng Loading
    document.getElementById('login-overlay').style.display = 'none';
    document.getElementById('loading-screen').style.display = 'flex';
    
    setupSocketListeners();
    startLoadingAnimation();
}

function setupSocketListeners() {
    // Nhận trạng thái game từ server
    socket.on('init', (data) => {
        phase = data.phase;
        timer = data.timer;
        document.getElementById('session-id').innerText = data.session;
        updateUI();
    });

    // Đồng hồ đếm ngược
    socket.on('tick', (data) => {
        timer = data.timer;
        phase = data.phase;
        updateUI();
    });

    // Mở bát
    socket.on('open-result', (data) => {
        resDice = data.dices;
        phase = 'NAN'; // Chuyển sang chế độ nặn
        document.getElementById('nan-text').style.display = 'block';
        // Hiển thị kết quả sau khi nặn hoặc tự động
    });

    // Phiên mới
    socket.on('new-session', (data) => {
        resetGameUI();
        document.getElementById('session-id').innerText = data.session;
    });

    socket.on('bet-ok', () => {
        confirmedMoney += pendingMoney;
        pendingMoney = 0;
        // Hiệu ứng chip xác nhận
        document.querySelectorAll('.pending-chip').forEach(chip => {
            chip.classList.remove('pending-chip');
            chip.classList.add('chip-confirmed');
        });
    });

    socket.on('error', (msg) => {
        showError(msg);
        cancelBet();
    });
}

// --- HÀM ĐẶT CƯỢC THẬT ---
function confirmBet() {
    if (pendingMoney <= 0 || phase !== 'BET' || timer <= 2) return;
    
    // Gửi lệnh cược lên Server (Server sẽ tự trừ tiền trong DB)
    socket.emit('bet', { 
        side: mySide, 
        amount: pendingMoney 
    });
}

// --- CẬP NHẬT GIAO DIỆN ---
function updateUI() {
    document.getElementById('balance').innerText = Math.floor(balance).toLocaleString();
    document.getElementById('bowl-timer').innerText = timer;
    
    // Logic hiển thị nút và trạng thái dựa trên timer/phase
    if (phase === 'RESULT') {
        document.getElementById('bowl-timer').style.color = '#ff4d4d';
    } else {
        document.getElementById('bowl-timer').style.color = '#fff';
    }
}

// ... Giữ các hàm playSnd, createChipEffect, showDiceUI của bạn ...
</script>
</body>
