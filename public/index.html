<script>
const SERVER_URL = "https://tiu-xai-server.onrender.com";
const SUPABASE_URL = "https://qimyjctcipdgkfhudunv.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let socket, balance = 0, timer = 30, phase = 'BET', mySide = null, pendingMoney = 0;

async function startLoading() {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) return alert("Vui lòng đăng nhập!");

    await fetchUserBalance(session.user.id);
    socket = io(SERVER_URL, { auth: { token: session.access_token }, transports: ["websocket"] });

    document.getElementById('login-overlay').style.display = 'none';
    setupSocketListeners();
}

async function fetchUserBalance(userId) {
    const { data } = await supabaseClient.from('players').select('balance').eq('id', userId).single();
    if (data) { balance = data.balance; updateUI(); }
}

function setupSocketListeners() {
    socket.on('tick', (data) => {
        timer = data.timer; phase = data.phase;
        updateUI();
    });

    socket.on('open-result', (data) => {
        showDiceUI(data.dices);
        if (data.winSide === mySide) playWinSound();
    });

    socket.on('new-session', (data) => {
        resetGameUI();
        document.getElementById('session-id').innerText = data.session;
    });

    socket.on('update-balance', (newBalance) => {
        balance = newBalance;
        updateUI();
    });

    socket.on('bet-ok', (data) => {
        if (data.newBalance) balance = data.newBalance;
        updateUI();
        document.querySelectorAll('.pending-chip').forEach(c => c.classList.replace('pending-chip', 'confirmed'));
    });
}

function confirmBet(side) {
    if (phase !== 'BET' || timer <= 2) return alert("Hết thời gian cược!");
    mySide = side;
    pendingMoney = 10000; // Ví dụ cược 10k
    socket.emit('bet', { side, amount: pendingMoney });
    placeChipEffect(side, pendingMoney);
}

function updateUI() {
    document.getElementById('balance').innerText = balance.toLocaleString();
    const tEl = document.getElementById('bowl-timer');
    tEl.innerText = timer;
    tEl.style.color = (timer <= 5 && phase === 'BET') ? 'red' : 'white';
}

function placeChipEffect(side, amt) {
    const area = document.getElementById(side === 'TAI' ? 'area-tai' : 'area-xiu');
    const chip = document.createElement('div');
    chip.className = 'chip pending-chip';
    chip.innerText = amt/1000 + "K";
    chip.style.left = Math.random()*70 + "%";
    chip.style.top = Math.random()*70 + "%";
    area.appendChild(chip);
}

function resetGameUI() {
    document.querySelectorAll('.chip').forEach(c => c.remove());
    document.getElementById('dice-area').innerHTML = "";
    mySide = null;
}
</script>
