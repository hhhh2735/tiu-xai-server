<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BÙI HẢI CASINO - PREMIUM PRO ONLINE</title>
    <link href="https://fonts.googleapis.com/css2?family=Goldman:wght@400;700&family=Montserrat:wght@400;900&display=swap" rel="stylesheet">
    <style>
        /* GIỮ NGUYÊN TOÀN BỘ CSS CỦA BẠN */
        :root {
            --gold: #ffd700; --gold-dark: #b8860b; --tai: #ff4d4d; --xiu: #00d2ff; --win: #2ecc71; --lose: #ff4d4d;
            --font-main: 'Montserrat', sans-serif; --font-title: 'Goldman', cursive;
        }
        * { box-sizing: border-box; user-select: none; font-family: var(--font-main); -webkit-tap-highlight-color: transparent; }
        html, body { margin: 0; background: #000; height: 100dvh; width: 100vw; overflow: hidden; touch-action: none; position: fixed; }

        /* --- GIAO DIỆN NHẬP TÊN (LOGIN) --- */
        #login-overlay { position: fixed; inset: 0; background: radial-gradient(circle at center, #1e293b 0%, #000 100%); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-card { width: 90%; max-width: 400px; padding: 40px 25px; background: rgba(15, 23, 42, 0.9); border: 2px solid var(--gold); border-radius: 20px; box-shadow: 0 0 50px rgba(255, 215, 0, 0.2), inset 0 0 20px rgba(255, 215, 0, 0.1); text-align: center; position: relative; }
        .login-card::before { content: "★ ★ ★ ★ ★"; position: absolute; top: -15px; left: 50%; transform: translateX(-50%); background: #000; padding: 0 15px; color: var(--gold); font-size: 20px; }
        .login-box input { width: 100%; padding: 18px; border-radius: 12px; border: 1px solid var(--gold-dark); background: rgba(0,0,0,0.8); color: var(--gold); font-size: 18px; text-align: center; margin-bottom: 25px; outline: none; font-weight: bold; box-shadow: inset 0 2px 10px rgba(0,0,0,0.5); }
        .btn-start { width: 100%; padding: 18px; background: linear-gradient(180deg, var(--gold) 0%, var(--gold-dark) 100%); color: #000; border: none; border-radius: 12px; font-weight: 900; font-size: 20px; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; box-shadow: 0 5px 15px rgba(0,0,0,0.4); }

        /* --- GIAO DIỆN LOADING --- */
        #loading-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .logo-load { font-family: var(--font-title); font-size: 55px; background: linear-gradient(to bottom, #fff 20%, var(--gold) 50%, var(--gold-dark) 80%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.5)); }
        .progress-w { width: 280px; height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; border: 1px solid rgba(255,215,0,0.3); }
        .progress-b { width: 0%; height: 100%; background: linear-gradient(90deg, var(--gold-dark), var(--gold), #fff); box-shadow: 0 0 20px var(--gold); }

        /* --- GAME STAGE --- */
        #container-box { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        #game-stage { position: relative; width: 100%; max-width: 950px; aspect-ratio: 16/9; background: radial-gradient(circle at center, #1e293b, #020617); border: 2px solid #334155; border-radius: 30px; overflow: hidden; display: none; box-shadow: 0 0 60px rgba(0,0,0,1); }

        /* HUD & BOXES */
        .top-hud { position: absolute; top: 0; width: 100%; height: 65px; display: flex; justify-content: space-between; align-items: center; padding: 0 25px; z-index: 100; background: rgba(0,0,0,0.6); }
        .balance-box { background: rgba(255,215,0,0.1); border: 2px solid var(--gold); padding: 4px 15px; border-radius: 50px; color: var(--gold); font-size: 17px; font-weight: 900; }
        .bet-grid { position: absolute; top: 25%; width: 100%; display: flex; justify-content: space-between; padding: 0 50px; z-index: 5; }
        .bet-box { width: 250px; height: 160px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.1); border-radius: 25px; display: flex; flex-direction: column; align-items: center; position: relative; cursor: pointer; }
        .bet-box.locked { opacity: 0.2; filter: grayscale(1); pointer-events: none; }
        .title { font-size: 85px; font-weight: 900; margin-top: -5px; opacity: 0.7; }
        
        .plate-wrap { position: absolute; top: 48%; left: 50%; transform: translate(-50%, -50%); width: 180px; height: 180px; z-index: 10; display: flex; justify-content: center; align-items: center; }
        .plate-base { position: absolute; inset: 0; border-radius: 50%; background: #0f172a; border: 8px solid #334155; }
        .bowl { position: absolute; width: 145px; height: 145px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #f8fafc, #64748b, #0f172a); z-index: 50; display: flex; justify-content: center; align-items: center; cursor: grab; box-shadow: 0 10px 25px rgba(0,0,0,0.6); transition: opacity 0.5s; }
        #bowl-timer { font-size: 60px; color: #fff; font-weight: 900; font-family: var(--font-title); }

        /* CHIPS & FOOTER */
        .footer { position: absolute; bottom: 0; width: 100%; height: 160px; background: #000; display: flex; flex-direction: column; align-items: center; z-index: 110; border-top: 1px solid #222; }
        .chip-btn { width: 44px; height: 44px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: 900; cursor: pointer; color: #fff; }
        .chip-btn.active { transform: translateY(-8px); border-color: #fff; box-shadow: 0 0 10px #fff; }
        .chip-item { position: absolute; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 8px; color: #fff; font-weight: 900; z-index: 11; transition: all 0.3s; }
        
        /* 3D DICE CSS (GIỮ NGUYÊN TỪ CODE CỦA BẠN) */
        .dice { width: 40px; height: 40px; position: relative; transform-style: preserve-3d; transition: transform 0.5s; }
        .face { position: absolute; width: 40px; height: 40px; background: #fff; border: 1px solid #ccc; border-radius: 6px; display: grid; grid-template: repeat(3, 1fr) / repeat(3, 1fr); padding: 3px; }
        .dot { width: 8px; height: 8px; background: #333; border-radius: 50%; justify-self: center; align-self: center; }
        .dot.red { background: #e74c3c; }
        .f1 { transform: translateZ(20px); } .f2 { transform: rotateY(180deg) translateZ(20px); }
        .f3 { transform: rotateY(90deg) translateZ(20px); } .f4 { transform: rotateY(-90deg) translateZ(20px); }
        .f5 { transform: rotateX(90deg) translateZ(20px); } .f6 { transform: rotateX(-90deg) translateZ(20px); }
        
        /* CÁC CSS KHÁC (HISTORY, POPUP, CHAT...) GIỮ NGUYÊN */
        #history-road { position: absolute; bottom: 175px; right: 20px; display: flex; gap: 5px; background: rgba(0,0,0,0.6); padding: 8px; border-radius: 12px; z-index: 100; }
        .road-dot { width: 26px; height: 26px; border-radius: 50%; font-size: 11px; font-weight: 900; display: flex; align-items: center; justify-content: center; }
        .dot-tai { background: radial-gradient(circle, #ff6b6b, #b91c1c); } .dot-xiu { background: radial-gradient(circle, #4facfe, #0062ff); }
        .popup { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 420px; background: #111; border: 1px solid #333; border-radius: 20px; padding: 20px; display: none; flex-direction: column; z-index: 1000; }
    </style>
</head>

<body onclick="initAudio()">

    <div id="login-overlay">
        <div class="login-card">
            <div class="logo-load">BÙI HẢI</div>
            <div class="login-box">
                <input type="text" id="user-input-name" placeholder="NHẬP TÊN NHÂN VẬT..." maxlength="15">
                <button class="btn-start" onclick="startLoading()">VÀO GAME</button>
            </div>
        </div>
    </div>

    <div id="loading-screen">
        <div class="logo-load">BÙI HẢI CASINO</div>
        <div class="progress-w"><div class="progress-b" id="load-bar"></div></div>
        <div id="load-pct" style="color: var(--gold); margin-top:10px">0%</div>
    </div>

    <div id="container-box">
        <div id="game-stage">
            <div class="top-hud">
                <div class="user-info">
                    <div id="display-user-name" style="color:white; font-size:12px">PLAYER</div>
                    <div class="balance-box">TK: <span id="balance">0</span></div>
                </div>
                <div style="color:var(--gold)">PHIÊN: #<span id="session-id">1001</span></div>
                <button onclick="openNap()" style="background:var(--win); border:none; padding:8px 15px; color:white; border-radius:8px; font-weight:bold">NẠP</button>
            </div>

            <div class="bet-grid">
                <div class="bet-box" id="area-XIU" onclick="handlePlaceBet('XIU', event)">
                    <div class="title" style="color:var(--xiu)">XỈU</div>
                    <div id="my-xiu" style="color:var(--gold); font-weight:900">0</div>
                    <div class="chip-container" id="chips-XIU"></div>
                </div>
                <div class="bet-box" id="area-TAI" onclick="handlePlaceBet('TAI', event)">
                    <div class="title" style="color:var(--tai)">TÀI</div>
                    <div id="my-tai" style="color:var(--gold); font-weight:900">0</div>
                    <div class="chip-container" id="chips-TAI"></div>
                </div>
            </div>

            <div class="plate-wrap">
                <div id="next-session-timer" style="position: absolute; top: -50px; color: var(--gold); display: none;">PHIÊN MỚI: <span id="sec-left">0</span>s</div>
                <div class="plate-base"></div>
                <div id="dice-group" style="display:none; position: absolute; z-index: 20; gap: 10px;"></div>
                <div class="bowl" id="bowl"><div id="bowl-timer">45</div></div>
                <div id="nan-text" style="position:absolute; z-index:60; color:var(--gold); display:none">MỜI NẶN</div>
            </div>

            <div id="res-splash" style="position: absolute; top: 40%; left: 50%; transform: translate(-50%,-50%) scale(0); font-size: 60px; font-weight: 900; z-index: 200; transition: 0.4s;"></div>

            <div id="history-road"></div>

            <div class="footer">
                <div class="chip-rack" style="display:flex; gap:8px; margin-top:15px">
                    <div class="chip-btn" style="background:#607d8b" onclick="selChip(1000, this)">1K</div>
                    <div class="chip-btn" style="background:#2196f3" onclick="selChip(10000, this)">10K</div>
                    <div class="chip-btn active" style="background:#e91e63" onclick="selChip(100000, this)">100K</div>
                    <div class="chip-btn" style="background:#f44336" onclick="selChip(1000000, this)">1M</div>
                </div>
                <div style="margin-top:15px">
                    <button onclick="cancelBet()" style="padding:10px 25px; background:#333; color:white; border:none; border-radius:8px">HỦY</button>
                    <button onclick="confirmBet()" style="padding:10px 25px; background:var(--gold); border:none; border-radius:8px; font-weight:bold">XÁC NHẬN</button>
                </div>
            </div>
        </div>
    </div>

    <div id="nap-popup" class="popup">
        <h2 style="color:var(--gold); text-align:center">NẠP TIỀN</h2>
        <input type="number" id="nap-amount" value="1000000" style="width:100%; padding:15px; background:#000; color:var(--gold); border:1px solid #444; text-align:center; font-size:20px">
        <button onclick="finishNap()" style="margin-top:20px; padding:15px; background:var(--win); color:white; border:none; border-radius:10px; font-weight:bold">XÁC NHẬN NẠP</button>
        <button onclick="closePopups()" style="color:gray; background:none; border:none; margin-top:10px">Đóng</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let balance = 0, selectedAmt = 100000, timer = 45, phase = 'BET', playerName = "";
        let mySide = null, pendingMoney = 0, confirmedMoney = 0, resDice = [1,1,1];
        let isResultProcessed = false, audioInited = false;

        // --- ĐỒNG BỘ SERVER ---
        socket.on('tick', (data) => {
            timer = data.timer;
            phase = data.phase;
            updateUI();
            if (phase === 'BET' && timer === 45) resetGameUI();
        });

        socket.on('new-session', (data) => {
            document.getElementById('session-id').innerText = data.session;
            resetGameUI();
        });

        socket.on('finish-bet', (data) => {
            resDice = data.dice;
            // Chuyển sang giai đoạn nặn
            phase = 'NAN';
            document.getElementById('nan-text').style.display = 'block';
            document.getElementById('bowl-timer').style.display = 'none';
        });

        socket.on('update-balance', (newBalance) => {
            balance = newBalance;
            updateUI();
        });

        // --- LOGIN & LOADING ---
        function startLoading() {
            playerName = document.getElementById('user-input-name').value || "Guest" + Math.floor(Math.random()*999);
            document.getElementById('display-user-name').innerText = playerName;
            socket.emit('join-game', playerName);
            
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('loading-screen').style.display = 'flex';
            
            let w = 0;
            let itv = setInterval(() => {
                w += 5;
                document.getElementById('load-bar').style.width = w + '%';
                document.getElementById('load-pct').innerText = w + '%';
                if(w >= 100) {
                    clearInterval(itv);
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('game-stage').style.display = 'block';
                }
            }, 50);
        }

        // --- LOGIC GAME ---
        function selChip(v, el) {
            selectedAmt = v;
            document.querySelectorAll('.chip-btn').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
        }

        function handlePlaceBet(side, e) {
            if(phase !== 'BET' || timer < 5) return;
            if(mySide && mySide !== side) return;
            if(balance < (pendingMoney + confirmedMoney + selectedAmt)) return;

            mySide = side;
            pendingMoney += selectedAmt;
            
            // Hiệu ứng Chip
            const container = document.getElementById(`chips-${side}`);
            const chip = document.createElement('div');
            chip.className = 'chip-item pending';
            chip.style.background = e.target.style.color || '#gold';
            chip.style.left = Math.random()*60 + 20 + '%';
            chip.style.top = Math.random()*50 + 20 + '%';
            chip.innerText = selectedAmt/1000 + 'K';
            container.appendChild(chip);
            
            document.getElementById(`area-${side === 'TAI' ? 'XIU' : 'TAI'}`).classList.add('locked');
            updateUI();
        }

        function confirmBet() {
            if(pendingMoney <= 0) return;
            socket.emit('place-bet', {
                username: playerName,
                amount: pendingMoney,
                side: mySide
            });
            confirmedMoney += pendingMoney;
            pendingMoney = 0;
            document.querySelectorAll('.chip-item.pending').forEach(c => c.classList.remove('pending'));
        }

        function cancelBet() {
            if(confirmedMoney > 0 || timer < 5) return;
            pendingMoney = 0;
            mySide = null;
            document.querySelectorAll('.chip-item.pending').forEach(c => c.remove());
            document.querySelectorAll('.bet-box').forEach(b => b.classList.remove('locked'));
            updateUI();
        }

        // --- NẶN BÁT ---
        let bowl = document.getElementById('bowl'), isDrg = false, bX = 0, bY = 0, sX, sY;
        bowl.onmousedown = bowl.ontouchstart = (e) => {
            if(phase !== 'NAN') return;
            isDrg = true;
            let p = e.touches ? e.touches[0] : e;
            sX = p.clientX - bX; sY = p.clientY - bY;
        };
        window.onmousemove = window.ontouchmove = (e) => {
            if(!isDrg) return;
            let p = e.touches ? e.touches[0] : e;
            bX = p.clientX - sX; bY = p.clientY - sY;
            bowl.style.transform = `translate(${bX}px, ${bY}px)`;
            if(Math.hypot(bX, bY) > 100) {
                isDrg = false;
                bowl.style.opacity = '0';
                setTimeout(showResult, 200);
            }
        };
        window.onmouseup = window.ontouchend = () => { isDrg = false; if(Math.hypot(bX, bY) <= 100) { bX=0; bY=0; bowl.style.transform = 'none'; } };

        function showResult() {
            if(isResultProcessed) return;
            isResultProcessed = true;
            
            const sum = resDice.reduce((a,b) => a+b, 0);
            const winSide = sum > 10 ? 'TAI' : 'XIU';
            
            // Hiện xúc xắc
            const g = document.getElementById('dice-group');
            g.innerHTML = '';
            resDice.forEach(v => g.appendChild(create3DDice(v)));
            g.style.display = 'flex';

            // Splash kết quả
            const spl = document.getElementById('res-splash');
            spl.innerText = winSide + ' ' + sum;
            spl.style.color = winSide === 'TAI' ? 'var(--tai)' : 'var(--xiu)';
            spl.style.transform = 'translate(-50%,-50%) scale(1.5)';
            
            document.getElementById('next-session-timer').style.display = 'block';
        }

        function create3DDice(val) {
            const d = document.createElement('div'); d.className = 'dice';
            const rots = {1:'rotateX(0deg)', 2:'rotateY(180deg)', 3:'rotateY(-90deg)', 4:'rotateY(90deg)', 5:'rotateX(-90deg)', 6:'rotateX(90deg)'};
            d.style.transform = rots[val];
            for(let i=1; i<=6; i++) {
                const f = document.createElement('div'); f.className = `face f${i}`;
                // Đơn giản hóa chấm xúc xắc
                f.innerText = i; f.style.display='flex'; f.style.alignItems='center'; f.style.justifyContent='center'; f.style.fontWeight='900';
                d.appendChild(f);
            }
            return d;
        }

        function resetGameUI() {
            isResultProcessed = false;
            mySide = null; pendingMoney = 0; confirmedMoney = 0;
            bowl.style.opacity = '1'; bowl.style.transform = 'none'; bX=0; bY=0;
            document.getElementById('bowl-timer').style.display = 'flex';
            document.getElementById('dice-group').style.display = 'none';
            document.getElementById('res-splash').style.transform = 'translate(-50%,-50%) scale(0)';
            document.getElementById('next-session-timer').style.display = 'none';
            document.getElementById('nan-text').style.display = 'none';
            document.querySelectorAll('.chip-container').forEach(c => c.innerHTML = '');
            document.querySelectorAll('.bet-box').forEach(b => b.classList.remove('locked'));
        }

        function updateUI() {
            document.getElementById('balance').innerText = Math.floor(balance).toLocaleString();
            document.getElementById('bowl-timer').innerText = timer;
            document.getElementById('sec-left').innerText = timer;
            document.getElementById('my-xiu').innerText = (mySide === 'XIU' ? (pendingMoney + confirmedMoney) : 0).toLocaleString();
            document.getElementById('my-tai').innerText = (mySide === 'TAI' ? (pendingMoney + confirmedMoney) : 0).toLocaleString();
        }

        function openNap() { document.getElementById('nap-popup').style.display = 'flex'; }
        function closePopups() { document.getElementById('nap-popup').style.display = 'none'; }
        function finishNap() {
            const amt = parseInt(document.getElementById('nap-amount').value);
            // Giả lập nạp tiền bằng cách cộng thẳng (Trong thực tế cần gửi lên server)
            balance += amt;
            updateUI();
            closePopups();
        }
        function initAudio() { audioInited = true; }
    </script>
</body>
</html>
